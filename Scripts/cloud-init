#cloud-config
#!
package_update: true
package_upgrade: true

#packages:
# - nginx
# - wget
# - curl

disk_setup:
  /dev/xvdf:
    LOGS:
      table_type: 'mbr'
      layout: 
        - 100
      overwrite: False

fs_setup:
  - label: logs
    filesystem: 'ext4'
    device: /dev/xvdf
    partition: sda1

runcmd:
  - partx --update /dev/xvdf
  - partprobe 
  - mkdir -p /mnt/logs /test/access /test/error
  - mkdir /run/stage
  - sudo apt update 
  - apt install nginx wget curl -y 
  - apt autoclean 
  - wget -O /run/stage/index.html https://raw.githubusercontent.com/gustavmk/hollow_aws/main/nginx/index.html
  - wget -O /run/stage/custom_50x.html https://raw.githubusercontent.com/gustavmk/hollow_aws/main/nginx/custom_50x.html 
  - wget -O /run/stage/default.conf https://raw.githubusercontent.com/gustavmk/hollow_aws/main/nginx/default.conf
  - mv /run/stage/default.conf /etc/nginx/sites-enabled/default
  - mv /run/stage/custom_50x.html /usr/share/nginx/html/custom_50x.html
  - mv /run/stage/index.html  /usr/share/nginx/html 
  - systemctl reload nginx
 
mounts:
  - ["/dev/xvdf", "/mnt/logs"]


final_message: "The system is finally up, after $UPTIME seconds"

# LOG: /var/log/cloud-init.log